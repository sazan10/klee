name: Build klee

on:
  push:

jobs:
  run-jpf:
    runs-on: ubuntu-22.04
    name: Build Klee

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get install wget build-essential cmake curl file g++-multilib gcc-multilib git libunwind-dev libcap-dev libgoogle-perftools-dev libncurses5-dev libsqlite3-dev libtcmalloc-minimal4 python3-pip unzip graphviz doxygen
        sudo pip3 install lit wllvm
        sudo apt-get install python3-tabulate
        pip3 install --user lit wllvm
    - name: Install llvm 3
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key|sudo apt-key add -      
        sudo apt-get install clang-13 llvm-13 llvm-13-dev llvm-13-tools 
    - name: Install deps for STP
      run: | 
        sudo apt-get update
        sudo apt-get -y install tzdata
        sudo apt-get install -y cmake bison flex libboost-all-dev libgmp-dev python2 perl
        sudo apt-get install -y git
        sudo apt-get install -y g++ gcc 
    - name: Setup stp
      run: |
        git clone https://github.com/stp/stp
        cd stp
        git submodule init && git submodule update  
        ./scripts/deps/setup-gtest.sh
        ./scripts/deps/setup-outputcheck.sh
        ./scripts/deps/setup-cms.sh
        ./scripts/deps/setup-minisat.sh
        mkdir build
        cd build
        cmake ..
        cmake --build .
        sudo cmake --install .
    - name: Build klee
      run: |
        mkdir build
        cd build
        cmake ../
        # cmake -DENABLE_UNIT_TESTS=ON -ENABLE_SYSTEM_TESTS=ON -DGTEST_SRC_DIR=~/klee/test ../
        make
        sudo make check
